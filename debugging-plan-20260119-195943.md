# Debugging Plan: Unprivileged test run repeats lifecycle setup logs

**Generated**: 2026-01-19 19:59:43 UTC  
**Issue ID**: N/A  
**Severity**: Medium

## Problem Statement

During the unprivileged test run, the logs repeatedly emit the lifecycle setup
span entries ("setup" and "setup:install") without progressing, suggesting an
infinite loop or repeated setup invocation. The expected behaviour is a single
setup/start/stop sequence per test with eventual completion. This stalls the
unprivileged test run and blocks CI feedback.

## Context Summary

| Aspect | Details |
|--------|---------|
| First observed | 2026-01-19 (current branch) |
| Reproduction rate | Unknown (reported during unprivileged test run) |
| Affected components | `tests/observability.rs`, `TestCluster` lifecycle, `postgresql_embedded` setup |
| Recent changes | Observability test refactor; now using `WorkerOperation` for lifecycle mapping |

### Error Artefacts

```text
test_cluster:lifecycle_operation{operation="setup" privileges=Unprivileged
  mode=InProcess}:setup:postgresql_embedded::postgresql: enter",
" INFO test_cluster:lifecycle_operation{operation="setup"
  privileges=Unprivileged mode=InProcess}:setup:install:
  postgresql_embedded::postgresql: enter", ...
(repeats)
```

### Information Gaps

- Exact test command used (e.g., `make test`, `nextest` profile, filtered tests)?
- Whether the repetition is infinite vs. very slow progress?
- CPU/disk usage during the hang?
- Which test case is running when the repetition begins?
- Whether this is reproducible outside the observability scenarios?

---

## Hypotheses

### H1: `TestCluster::new` is being invoked repeatedly in a looped test path

**Claim**: The unprivileged test path is re-entering the cluster setup (e.g.,
fixture/BDD step loop) causing repeated setup spans, rather than a single setup
that hangs.

**Plausibility**: Medium — repeated "enter" logs can also be produced by
repeated setup calls rather than a single hung call.

**Prediction**: If true, instrumentation around `when_cluster_boots` or
`TestCluster::new` will show multiple invocations per single test case.

#### Falsification Plan (H1)

| Step | Action | Expected Negative Result |
|------|--------|--------------------------|
| 1 | Add a temporary counter/log in `tests/observability.rs` around `TestCluster::new` with a unique test ID, rerun only the unprivileged failing test. | The counter logs show exactly one invocation per test. |
| 2 | Run the specific test with `--nocapture` and verify that the repetition occurs without a new test case starting. | Repetition occurs without a new test case boundary. |

**Tooling**: `cargo nextest run -p pg-embed-setup-unpriv --test observability
--nocapture` (or equivalent), temporary `tracing::info!` in test.

**Confidence on falsification**: High — clear count makes this easy to disprove.

---

### H2: `postgresql_embedded::setup()` retries due to persistent installation failure

**Claim**: The embedded installer repeatedly re-enters the setup/installation path
because it fails to complete (e.g., corrupted installation dir, permission issues,
missing binaries), resulting in repeated "enter" logs.

**Plausibility**: High — the log alternates between setup and installation entry
points; repeated installation suggests internal retry.

**Prediction**: If true, filesystem state will show partial installation artifacts
and logs/errors around the installation step (even if swallowed).

#### Falsification Plan (H2)

| Step | Action | Expected Negative Result |
|------|--------|--------------------------|
| 1 | Run the failing test with `RUST_LOG=postgresql_embedded=trace,pg_embedded_setup_unpriv=trace` and `--nocapture` to surface installation errors. | No installation errors or retry indicators appear; only single setup attempt. |
| 2 | Inspect the installation directory (`TestCluster` installation dir) during the hang to confirm whether files are changing or re-created. | Directory is stable and complete, indicating no retry loop. |

**Tooling**: `RUST_LOG=...`, `ls -l`/`find` on installation dir, optional
`strace -f` on the test process.

**Confidence on falsification**: Medium — logs may be noisy; filesystem checks help.

---

### H3: Tracing subscriber/log capture is re-entrantly logging span enter events

**Claim**: The test log capture (`capture_info_logs_with_spans`) is causing
re-entrant span enter events (e.g., subscriber recursion), resulting in repeated
"enter" lines without actual lifecycle retries.

**Plausibility**: Medium — repeated "enter" could be a logging artefact rather
than real setup re-entry.

**Prediction**: If true, the process is not stuck in setup; removing the log
capture or switching to a simpler subscriber will stop the repetition while the
test still runs.

#### Falsification Plan (H3)

| Step | Action | Expected Negative Result |
|------|--------|--------------------------|
| 1 | Temporarily replace `capture_info_logs_with_spans` with a minimal subscriber or disable span capture in the failing test. | The repetition persists even without span capture. |
| 2 | Run the same test outside the log-capture helper and compare timing. | The test still hangs while logging is minimal. |

**Tooling**: Temporary test-only change, `cargo nextest run --nocapture`.

**Confidence on falsification**: Medium — requires a controlled change, but
cleanly isolates logging.

---

### H4: Unprivileged runtime missing a required dependency, causing retry loop

**Claim**: The unprivileged setup depends on a tool/library (e.g., `tar`,
`xz`, `patchelf`) that is absent, and the installer repeatedly retries without
emitting a fatal error.

**Plausibility**: Low–Medium — dependency issues can cause repeated setup.

**Prediction**: If true, reproducing in a clean environment or verifying
availability of required tools will surface missing dependencies or a more
explicit error.

#### Falsification Plan (H4)

| Step | Action | Expected Negative Result |
|------|--------|--------------------------|
| 1 | Check for required external tools and shared libs (e.g., `tar`, `xz`, `ldd` on binaries). | All required tools/libs are present and usable. |
| 2 | Run the same test on a different host/container image with tools known to be present. | The repetition still occurs. |

**Tooling**: `which tar xz`, `ldd`, alternate container/runtime.

**Confidence on falsification**: Low–Medium — environment-dependent.

---

## Recommended Execution Order

1. **H1** — cheapest and fastest; confirms whether setup is invoked repeatedly.
2. **H2** — most plausible if H1 falsified; inspect install loop + filesystem.
3. **H3** — isolates logging subsystem effects.
4. **H4** — broader environment verification if others fail.

## Termination Criteria

- **Root cause identified**: A hypothesis survives falsification and explains
  the repeated setup logs with corroborating evidence.
- **Escalation trigger**: All hypotheses falsified or reproduction unclear —
  collect full trace logs and open a new round of hypotheses.

## Notes for Executing Agent

- Prefer running a single test case with `--nocapture` to reduce noise.
- Use the unprivileged test profile/feature flags that match the failing run.
- Keep temporary instrumentation local to tests and revert once falsified.
